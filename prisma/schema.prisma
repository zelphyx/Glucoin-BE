// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@glucoin/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String    @id @default(uuid())
  email                    String    @unique
  password                 String
  full_name                String
  golongan_darah           String?
  tekanan_darah            String?
  alergi                   String?
  role                     UserRole
  date_of_birth            DateTime?
  gender                   Gender?
  weight_kg                Decimal?
  height_cm                Decimal?
  phone_number             String?
  whatsapp_number          String?
  profile_picture_url      String?
  is_verified              Boolean   @default(false)
  email_verified_at        DateTime?
  otp_code                 String?
  otp_expires_at           DateTime?
  password_reset_token     String?
  password_reset_expires   DateTime?
  created_at               DateTime  @default(now())
  updated_at               DateTime  @updatedAt
  last_login_at            DateTime?
  
  // Diabetes-specific fields
  diabetes_type            DiabetesType?     // Tipe diabetes (Type 1, Type 2, Gestational, Pre-diabetes)
  diagnosis_date           DateTime?         // Tanggal diagnosis diabetes
  target_glucose_min       Int?              // Target gula darah minimum (mg/dL)
  target_glucose_max       Int?              // Target gula darah maximum (mg/dL)
  hba1c_target             Decimal?          // Target HbA1c (%)
  last_hba1c               Decimal?          // Hasil HbA1c terakhir
  last_hba1c_date          DateTime?         // Tanggal cek HbA1c terakhir
  is_on_insulin            Boolean           @default(false)  // Apakah menggunakan insulin
  is_reminder_active       Boolean           @default(true)   // Aktifkan reminder WhatsApp
  
  Doctor                   Doctor?
  bookings                 Booking[]
  glucose_logs             GlucoseLog[]
  reminders                Reminder[]
  medication_logs          MedicationLog[]
}

model Doctor {
  id                       String   @id @default(uuid())
  user_id                  String   @unique
  specialization           String
  alamat_praktek          String
  price_range              String
  is_available             Boolean  @default(true)
  created_at               DateTime @default(now())
  updated_at               DateTime @updatedAt

  user      User               @relation(fields: [user_id], references: [id])
  schedules DoctorSchedule[]
  bookings  Booking[]
}

model DoctorSchedule {
  id          String      @id @default(uuid())
  doctor_id   String
  day_of_week DayOfWeek
  time_slot   String      // Format: "HH:mm" contoh: "11:00", "13:00", "15:00"
  duration_minutes Int     @default(60) // Durasi konsultasi dalam menit
  is_active   Boolean     @default(true)
  is_booked   Boolean     @default(false) // Apakah slot ini sudah di-booking untuk tanggal tertentu
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt

  doctor   Doctor    @relation(fields: [doctor_id], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@unique([doctor_id, day_of_week, time_slot])
  @@index([doctor_id, day_of_week])
}

model Booking {
  id                String        @id @default(uuid())
  user_id           String
  doctor_id         String
  schedule_id       String
  booking_date      DateTime      // Tanggal booking (misal: 18 Desember 2025)
  start_time        String        // Jam mulai (misal: "12:00")
  end_time          String        // Jam selesai (misal: "14:00")
  duration_minutes  Int           // Durasi dalam menit (misal: 120)
  consultation_type ConsultationType
  consultation_fee  Decimal       // Biaya konsultasi
  status            BookingStatus @default(PENDING_PAYMENT)
  payment_status    PaymentStatus @default(PENDING)
  notes             String?       // Catatan tambahan dari user
  cancellation_reason String?     // Alasan pembatalan (jika ada)
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt

  user     User           @relation(fields: [user_id], references: [id])
  doctor   Doctor         @relation(fields: [doctor_id], references: [id])
  schedule DoctorSchedule @relation(fields: [schedule_id], references: [id])
  payment  Payment?

  @@unique([schedule_id, booking_date]) // Satu slot hanya bisa di-booking sekali per tanggal
  @@index([user_id])
  @@index([doctor_id])
  @@index([booking_date])
}

model Payment {
  id                  String        @id @default(uuid())
  booking_id          String        @unique
  order_id            String        @unique // Midtrans order ID
  amount              Decimal
  payment_type        String?       // bank_transfer, gopay, etc
  transaction_id      String?       // Midtrans transaction ID
  transaction_status  String?       // capture, settlement, pending, deny, cancel, expire
  transaction_time    DateTime?
  snap_token          String?       // Midtrans Snap token
  snap_redirect_url   String?       // Midtrans Snap redirect URL
  payment_url         String?       // URL untuk pembayaran
  va_number           String?       // Virtual account number (jika bank transfer)
  bank                String?       // Bank name (jika bank transfer)
  expiry_time         DateTime?
  status              PaymentStatus @default(PENDING)
  raw_response        String?       // JSON response dari Midtrans
  created_at          DateTime      @default(now())
  updated_at          DateTime      @updatedAt

  booking Booking @relation(fields: [booking_id], references: [id])

  @@index([order_id])
  @@index([transaction_id])
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum ConsultationType {
  ONLINE
  OFFLINE // Langsung ke Tempat
}

enum BookingStatus {
  PENDING_PAYMENT  // Menunggu pembayaran
  PENDING          // Sudah bayar, menunggu konfirmasi dokter
  CONFIRMED        // Dikonfirmasi dokter
  COMPLETED        // Selesai konsultasi
  CANCELLED        // Dibatalkan
  EXPIRED          // Pembayaran kadaluarsa
}

enum PaymentStatus {
  PENDING          // Menunggu pembayaran
  PAID             // Sudah dibayar
  FAILED           // Gagal
  EXPIRED          // Kadaluarsa
  REFUNDED         // Dikembalikan
}

enum UserRole {
  ADMIN
  USER
  DOCTOR
}

enum Gender {
  MALE
  FEMALE
}

// ============= MARKETPLACE MODELS =============

model Product {
  id                String      @id @default(uuid())
  name              String
  description       String
  price             Decimal     // Harga asli
  discount_percent  Int         @default(0) // Diskon dalam persen (0-100)
  final_price       Decimal     // Harga setelah diskon
  rating            Decimal     @default(0) // Rating 0-5
  rating_count      Int         @default(0) // Jumlah rating
  quantity          Int         @default(0) // Stok produk
  image_url         String?
  category          ProductCategory
  is_active         Boolean     @default(true)
  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt

  cart_items   CartItem[]
  order_items  OrderItem[]
  reviews      ProductReview[]

  @@index([category])
  @@index([is_active])
}

model ProductReview {
  id          String   @id @default(uuid())
  product_id  String
  user_id     String
  rating      Int      // 1-5
  comment     String?
  created_at  DateTime @default(now())

  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([product_id, user_id]) // 1 user hanya bisa review 1x per produk
  @@index([product_id])
}

model Cart {
  id          String     @id @default(uuid())
  user_id     String     @unique
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  items CartItem[]

  @@index([user_id])
}

model CartItem {
  id          String   @id @default(uuid())
  cart_id     String
  product_id  String
  quantity    Int      @default(1)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  cart    Cart    @relation(fields: [cart_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([cart_id, product_id]) // 1 produk hanya 1 entry per cart
  @@index([cart_id])
  @@index([product_id])
}

model ShippingAddress {
  id              String   @id @default(uuid())
  user_id         String
  recipient_name  String   // Nama penerima
  phone_number    String
  address         String   // Alamat lengkap
  city            String
  province        String
  postal_code     String
  is_default      Boolean  @default(false)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  orders Order[]

  @@index([user_id])
}

model Order {
  id                  String        @id @default(uuid())
  user_id             String
  order_number        String        @unique // Format: ORD-YYYYMMDD-XXXX
  shipping_address_id String
  subtotal            Decimal       // Total harga produk
  shipping_cost       Decimal       // Ongkir
  discount_amount     Decimal       @default(0) // Potongan diskon
  total_amount        Decimal       // Grand total
  status              OrderStatus   @default(PENDING_PAYMENT)
  payment_status      PaymentStatus @default(PENDING)
  shipping_status     ShippingStatus @default(NOT_SHIPPED)
  tracking_number     String?       // Nomor resi pengiriman
  courier             String?       // Nama kurir (JNE, JNT, SiCepat, dll)
  notes               String?       // Catatan order
  paid_at             DateTime?
  shipped_at          DateTime?
  delivered_at        DateTime?
  created_at          DateTime      @default(now())
  updated_at          DateTime      @updatedAt

  shipping_address ShippingAddress   @relation(fields: [shipping_address_id], references: [id])
  items            OrderItem[]
  payment          OrderPayment?

  @@index([user_id])
  @@index([order_number])
  @@index([status])
}

model OrderItem {
  id              String   @id @default(uuid())
  order_id        String
  product_id      String
  product_name    String   // Snapshot nama produk saat order
  product_price   Decimal  // Snapshot harga saat order
  quantity        Int
  subtotal        Decimal  // product_price * quantity
  created_at      DateTime @default(now())

  order   Order   @relation(fields: [order_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id])

  @@index([order_id])
}

model OrderPayment {
  id                  String        @id @default(uuid())
  order_id            String        @unique
  order_payment_id    String        @unique // Midtrans order ID
  amount              Decimal
  payment_type        String?
  transaction_id      String?
  transaction_status  String?
  transaction_time    DateTime?
  snap_token          String?
  snap_redirect_url   String?
  va_number           String?
  bank                String?
  expiry_time         DateTime?
  status              PaymentStatus @default(PENDING)
  raw_response        String?
  created_at          DateTime      @default(now())
  updated_at          DateTime      @updatedAt

  order Order @relation(fields: [order_id], references: [id])

  @@index([order_payment_id])
  @@index([transaction_id])
}

enum ProductCategory {
  SUPPLEMENT     // Suplemen kesehatan
  MEDICINE       // Obat-obatan
  MEDICAL_DEVICE // Alat kesehatan (glukometer, dll)
  FOOD_DRINK     // Makanan & minuman sehat
  OTHER          // Lainnya
}

enum OrderStatus {
  PENDING_PAYMENT  // Menunggu pembayaran
  PROCESSING       // Sedang diproses
  SHIPPED          // Sudah dikirim
  DELIVERED        // Sudah diterima
  COMPLETED        // Selesai
  CANCELLED        // Dibatalkan
}

enum ShippingStatus {
  NOT_SHIPPED     // Belum dikirim
  PROCESSING      // Sedang dikemas
  SHIPPED         // Sudah dikirim
  IN_TRANSIT      // Dalam perjalanan
  DELIVERED       // Sudah diterima
}

// ============= HEALTHCARE FACILITIES (PostGIS) =============

model HealthcareFacility {
  id            String           @id @default(uuid())
  name          String
  type          FacilityType
  address       String
  city          String
  province      String
  phone         String?
  latitude      Decimal          // Koordinat latitude
  longitude     Decimal          // Koordinat longitude
  image_url     String?
  rating        Decimal          @default(0)
  rating_count  Int              @default(0)
  is_open_24h   Boolean          @default(false)
  opening_time  String?          // Format: "08:00"
  closing_time  String?          // Format: "22:00"
  is_active     Boolean          @default(true)
  created_at    DateTime         @default(now())
  updated_at    DateTime         @updatedAt

  @@index([type])
  @@index([city])
  @@index([is_active])
}

enum FacilityType {
  HOSPITAL     // Rumah Sakit
  PHARMACY     // Apotek
  CLINIC       // Klinik
  PUSKESMAS    // Puskesmas
  LAB          // Laboratorium
}

// ============= DIABETES MANAGEMENT MODELS =============

enum DiabetesType {
  TYPE_1           // Diabetes Tipe 1
  TYPE_2           // Diabetes Tipe 2
  GESTATIONAL      // Diabetes Gestasional (kehamilan)
  PRE_DIABETES     // Pre-diabetes
}

enum GlucoseCategory {
  FASTING          // Gula darah puasa (GDP)
  BEFORE_MEAL      // Sebelum makan
  AFTER_MEAL       // 2 jam setelah makan (GD2PP)
  RANDOM           // Gula darah sewaktu (GDS)
  BEDTIME          // Sebelum tidur
}

enum ReminderType {
  GLUCOSE_CHECK    // Reminder cek gula darah
  MEDICATION       // Reminder minum obat
  INSULIN          // Reminder suntik insulin
  EXERCISE         // Reminder olahraga
  APPOINTMENT      // Reminder jadwal dokter
  CUSTOM           // Reminder custom
}

// Log pencatatan gula darah
model GlucoseLog {
  id              String          @id @default(uuid())
  user_id         String
  glucose_level   Int             // Kadar gula darah (mg/dL)
  category        GlucoseCategory // Kategori pengukuran
  measured_at     DateTime        // Waktu pengukuran
  notes           String?         // Catatan (misal: setelah makan nasi goreng)
  is_normal       Boolean?        // Apakah dalam rentang normal
  created_at      DateTime        @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([measured_at])
  @@index([user_id, measured_at])
}

// Reminder harian
model Reminder {
  id              String        @id @default(uuid())
  user_id         String
  type            ReminderType
  title           String        // Judul reminder
  message         String        // Pesan yang dikirim
  time            String        // Format: "HH:mm" (contoh: "07:00", "12:00")
  days            String[]      // Hari aktif: ["MONDAY", "TUESDAY", ...] atau ["EVERYDAY"]
  is_active       Boolean       @default(true)
  last_sent_at    DateTime?     // Terakhir dikirim
  next_send_at    DateTime?     // Jadwal kirim berikutnya
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([is_active, next_send_at])
}

// Log minum obat
model MedicationLog {
  id              String    @id @default(uuid())
  user_id         String
  medication_name String    // Nama obat (Metformin, Glimepiride, Insulin, dll)
  dosage          String    // Dosis (500mg, 10 unit, dll)
  taken_at        DateTime  // Waktu minum obat
  notes           String?
  created_at      DateTime  @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([taken_at])
}
