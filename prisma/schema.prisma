// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@glucoin/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String    @id @default(uuid())
  email                    String    @unique
  password                 String
  full_name                String
  role                     UserRole
  date_of_birth            DateTime?
  gender                   Gender?
  weight_kg                Decimal?
  height_cm                Decimal?
  phone_number             String?
  whatsapp_number          String?
  profile_picture_url      String?
  is_verified              Boolean   @default(false)
  email_verified_at        DateTime?
  otp_code                 String?
  otp_expires_at           DateTime?
  password_reset_token     String?
  password_reset_expires   DateTime?
  created_at               DateTime  @default(now())
  updated_at               DateTime  @updatedAt
  last_login_at            DateTime?
  Doctor                   Doctor?
  bookings                 Booking[]
}

model Doctor {
  id                       String   @id @default(uuid())
  user_id                  String   @unique
  specialization           String
  alamat_praktek          String
  price_range              String
  is_available             Boolean  @default(true)
  created_at               DateTime @default(now())
  updated_at               DateTime @updatedAt

  user      User               @relation(fields: [user_id], references: [id])
  schedules DoctorSchedule[]
  bookings  Booking[]
}

model DoctorSchedule {
  id          String      @id @default(uuid())
  doctor_id   String
  day_of_week DayOfWeek
  time_slot   String      // Format: "HH:mm" contoh: "11:00", "13:00", "15:00"
  duration_minutes Int     @default(60) // Durasi konsultasi dalam menit
  is_active   Boolean     @default(true)
  is_booked   Boolean     @default(false) // Apakah slot ini sudah di-booking untuk tanggal tertentu
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt

  doctor   Doctor    @relation(fields: [doctor_id], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@unique([doctor_id, day_of_week, time_slot])
  @@index([doctor_id, day_of_week])
}

model Booking {
  id                String        @id @default(uuid())
  user_id           String
  doctor_id         String
  schedule_id       String
  booking_date      DateTime      // Tanggal booking (misal: 18 Desember 2025)
  start_time        String        // Jam mulai (misal: "12:00")
  end_time          String        // Jam selesai (misal: "14:00")
  duration_minutes  Int           // Durasi dalam menit (misal: 120)
  consultation_type ConsultationType
  consultation_fee  Decimal       // Biaya konsultasi
  status            BookingStatus @default(PENDING_PAYMENT)
  payment_status    PaymentStatus @default(PENDING)
  notes             String?       // Catatan tambahan dari user
  cancellation_reason String?     // Alasan pembatalan (jika ada)
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt

  user     User           @relation(fields: [user_id], references: [id])
  doctor   Doctor         @relation(fields: [doctor_id], references: [id])
  schedule DoctorSchedule @relation(fields: [schedule_id], references: [id])
  payment  Payment?

  @@unique([schedule_id, booking_date]) // Satu slot hanya bisa di-booking sekali per tanggal
  @@index([user_id])
  @@index([doctor_id])
  @@index([booking_date])
}

model Payment {
  id                  String        @id @default(uuid())
  booking_id          String        @unique
  order_id            String        @unique // Midtrans order ID
  amount              Decimal
  payment_type        String?       // bank_transfer, gopay, etc
  transaction_id      String?       // Midtrans transaction ID
  transaction_status  String?       // capture, settlement, pending, deny, cancel, expire
  transaction_time    DateTime?
  snap_token          String?       // Midtrans Snap token
  snap_redirect_url   String?       // Midtrans Snap redirect URL
  payment_url         String?       // URL untuk pembayaran
  va_number           String?       // Virtual account number (jika bank transfer)
  bank                String?       // Bank name (jika bank transfer)
  expiry_time         DateTime?
  status              PaymentStatus @default(PENDING)
  raw_response        String?       // JSON response dari Midtrans
  created_at          DateTime      @default(now())
  updated_at          DateTime      @updatedAt

  booking Booking @relation(fields: [booking_id], references: [id])

  @@index([order_id])
  @@index([transaction_id])
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum ConsultationType {
  ONLINE
  OFFLINE // Langsung ke Tempat
}

enum BookingStatus {
  PENDING_PAYMENT  // Menunggu pembayaran
  PENDING          // Sudah bayar, menunggu konfirmasi dokter
  CONFIRMED        // Dikonfirmasi dokter
  COMPLETED        // Selesai konsultasi
  CANCELLED        // Dibatalkan
  EXPIRED          // Pembayaran kadaluarsa
}

enum PaymentStatus {
  PENDING          // Menunggu pembayaran
  PAID             // Sudah dibayar
  FAILED           // Gagal
  EXPIRED          // Kadaluarsa
  REFUNDED         // Dikembalikan
}

enum UserRole {
  ADMIN
  USER
  DOCTOR
}

enum Gender {
  MALE
  FEMALE
}
